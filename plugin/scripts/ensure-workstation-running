#!/bin/bash
# Ensure the Workstation is running
# Called by SessionStart hook to auto-launch/install the workstation
#
# Behavior:
# - If autoLaunch is disabled (default): exit immediately
# - If autoLaunch is enabled: launch if not running, install if not found

SOCKET="/tmp/varie-workstation.sock"
STATE_DIR="$HOME/.varie"
CONFIG_FILE="$STATE_DIR/config.yaml"
MANAGER_JSON="$STATE_DIR/manager/state.json"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
INSTALL_SCRIPT="$SCRIPT_DIR/install-workstation"

# Check autoLaunch config (default: disabled)
AUTO_LAUNCH="false"
if [[ -f "$CONFIG_FILE" ]]; then
  if grep -q 'autoLaunch:[[:space:]]*true' "$CONFIG_FILE" 2>/dev/null; then
    AUTO_LAUNCH="true"
  fi
fi

# If autoLaunch is disabled, exit immediately (non-intrusive default)
if [[ "$AUTO_LAUNCH" != "true" ]]; then
  exit 0
fi

# Check if workstation is already running by pinging the Unix socket
if [[ -S "$SOCKET" ]]; then
  # Send a ping to the socket and check for response (ISSUE-039 fix)
  RESPONSE=$(echo '{"type":"ping"}' | nc -U -w1 "$SOCKET" 2>/dev/null || true)
  if [[ -n "$RESPONSE" ]]; then
    # Socket is responsive - app is running but maybe window is closed
    # Use 'open' to activate the app and bring window to front
    if [[ "$OSTYPE" == "darwin"* ]]; then
      for candidate in \
        "/Applications/Workstation.app" \
        "$HOME/Applications/Workstation.app"; do
        if [[ -d "$candidate" ]]; then
          open "$candidate"  # Activate existing app
          break
        fi
      done
    fi
    exit 0
  else
    # Stale socket from crashed workstation — clean up
    rm -f "$SOCKET"
  fi
fi

# Find and launch workstation based on OS
if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS - check for packaged app
  APP_PATH=""
  for candidate in \
    "/Applications/Workstation.app" \
    "$HOME/Applications/Workstation.app"; do
    if [[ -d "$candidate" ]]; then
      APP_PATH="$candidate"
      break
    fi
  done

  if [[ -n "$APP_PATH" ]]; then
    # Launch app (will activate if already running)
    open "$APP_PATH" &
  else
    # Not installed as app — try dev mode (running from source)
    # Check if we're in the varie-workstation repo with node_modules
    DEV_DIR="${CLAUDE_PLUGIN_ROOT}/.."
    if [[ -f "$DEV_DIR/node_modules/.bin/electron" ]] && [[ -f "$DEV_DIR/dist/main/index.js" ]]; then
      cd "$DEV_DIR"
      nohup npm run dev >/dev/null 2>&1 &
    else
      # Not installed — auto-download in background
      echo "[varie-workstation] Workstation not found. Downloading in background..."
      echo "[varie-workstation] Or download manually: https://github.com/varie-ai/workstation/releases"
      nohup "$INSTALL_SCRIPT" >/dev/null 2>&1 &
      exit 0
    fi
  fi

elif [[ "$OSTYPE" == "msys"* || "$OSTYPE" == "cygwin"* || "$OSTYPE" == "win32"* ]]; then
  # Windows
  APP="$LOCALAPPDATA/Programs/Workstation/Workstation.exe"

  if [[ -f "$APP" ]]; then
    "$APP" &
  else
    DEV_DIR="${CLAUDE_PLUGIN_ROOT}/.."
    if [[ -f "$DEV_DIR/node_modules/.bin/electron" ]] && [[ -f "$DEV_DIR/dist/main/index.js" ]]; then
      cd "$DEV_DIR"
      npm run dev &
    else
      echo "[varie-workstation] Workstation not found. Downloading in background..."
      echo "[varie-workstation] Or download manually: https://github.com/varie-ai/workstation/releases"
      nohup "$INSTALL_SCRIPT" >/dev/null 2>&1 &
      exit 0
    fi
  fi

elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  # Linux
  APP=""
  for path in "/usr/bin/varie-workstation" "/opt/Workstation/varie-workstation" "$HOME/.local/bin/varie-workstation"; do
    if [[ -f "$path" ]]; then
      APP="$path"
      break
    fi
  done

  if [[ -n "$APP" ]]; then
    nohup "$APP" >/dev/null 2>&1 &
  else
    DEV_DIR="${CLAUDE_PLUGIN_ROOT}/.."
    if [[ -f "$DEV_DIR/node_modules/.bin/electron" ]] && [[ -f "$DEV_DIR/dist/main/index.js" ]]; then
      cd "$DEV_DIR"
      nohup npm run dev >/dev/null 2>&1 &
    else
      echo "[varie-workstation] Workstation not found. Downloading in background..."
      echo "[varie-workstation] Or download manually: https://github.com/varie-ai/workstation/releases"
      nohup "$INSTALL_SCRIPT" >/dev/null 2>&1 &
      exit 0
    fi
  fi
fi

# Wait for socket to appear (max 5s, check every 250ms)
for i in $(seq 1 20); do
  if [[ -S "$SOCKET" ]]; then
    exit 0
  fi
  sleep 0.25
done

# Workstation didn't start in time — exit anyway, don't block Claude Code
exit 0
