#!/bin/bash
# Ensure the Workstation is running
# Called by SessionStart hook to auto-install and optionally auto-launch
#
# Behavior:
# - ALWAYS: if app not installed, download in background (silent)
# - If autoLaunch is enabled (default): launch if not running
# - If autoLaunch is disabled: skip launch

SOCKET="/tmp/varie-workstation.sock"
STATE_DIR="$HOME/.varie"
CONFIG_FILE="$STATE_DIR/config.yaml"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
INSTALL_SCRIPT="$SCRIPT_DIR/install-workstation"

# Check autoLaunch config (default: enabled)
AUTO_LAUNCH="true"
if [[ -f "$CONFIG_FILE" ]]; then
  if grep -q 'autoLaunch:[[:space:]]*false' "$CONFIG_FILE" 2>/dev/null; then
    AUTO_LAUNCH="false"
  fi
fi

# --- Step 1: Check if app is installed (always, regardless of autoLaunch) ---

is_installed() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    [[ -d "/Applications/Workstation.app" ]] || [[ -d "$HOME/Applications/Workstation.app" ]]
  elif [[ "$OSTYPE" == "msys"* || "$OSTYPE" == "cygwin"* || "$OSTYPE" == "win32"* ]]; then
    [[ -f "$LOCALAPPDATA/Programs/Workstation/Workstation.exe" ]]
  elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    [[ -f "$HOME/.local/bin/varie-workstation" ]]
  else
    return 1
  fi
}

# If not installed, trigger background download (even if autoLaunch=false)
if ! is_installed; then
  # Check dev mode as fallback before downloading
  DEV_DIR="${CLAUDE_PLUGIN_ROOT}/.."
  if [[ -f "$DEV_DIR/node_modules/.bin/electron" ]] && [[ -f "$DEV_DIR/dist/main/index.js" ]]; then
    # Dev mode available — only launch if autoLaunch=true
    if [[ "$AUTO_LAUNCH" == "true" ]]; then
      cd "$DEV_DIR"
      nohup npm run dev >/dev/null 2>&1 &
    fi
  else
    # Not installed, not in dev mode — download in background
    nohup "$INSTALL_SCRIPT" >/dev/null 2>&1 &
  fi
  exit 0
fi

# --- Step 2: App is installed — launch only if autoLaunch=true ---

if [[ "$AUTO_LAUNCH" != "true" ]]; then
  exit 0
fi

# Check if workstation is already running by pinging the Unix socket
if [[ -S "$SOCKET" ]]; then
  RESPONSE=$(echo '{"type":"ping"}' | nc -U -w1 "$SOCKET" 2>/dev/null || true)
  if [[ -n "$RESPONSE" ]]; then
    # Socket is responsive — app is running, activate window
    if [[ "$OSTYPE" == "darwin"* ]]; then
      for candidate in \
        "/Applications/Workstation.app" \
        "$HOME/Applications/Workstation.app"; do
        if [[ -d "$candidate" ]]; then
          open "$candidate"
          break
        fi
      done
    fi
    exit 0
  else
    # Stale socket from crashed workstation — clean up
    rm -f "$SOCKET"
  fi
fi

# Launch workstation
if [[ "$OSTYPE" == "darwin"* ]]; then
  for candidate in \
    "/Applications/Workstation.app" \
    "$HOME/Applications/Workstation.app"; do
    if [[ -d "$candidate" ]]; then
      open "$candidate" &
      break
    fi
  done

elif [[ "$OSTYPE" == "msys"* || "$OSTYPE" == "cygwin"* || "$OSTYPE" == "win32"* ]]; then
  APP="$LOCALAPPDATA/Programs/Workstation/Workstation.exe"
  if [[ -f "$APP" ]]; then
    "$APP" &
  fi

elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  for path in "/usr/bin/varie-workstation" "/opt/Workstation/varie-workstation" "$HOME/.local/bin/varie-workstation"; do
    if [[ -f "$path" ]]; then
      nohup "$path" >/dev/null 2>&1 &
      break
    fi
  done
fi

# Wait for socket to appear (max 5s, check every 250ms)
for i in $(seq 1 20); do
  if [[ -S "$SOCKET" ]]; then
    exit 0
  fi
  sleep 0.25
done

# Didn't start in time — exit anyway, don't block Claude Code
exit 0
