name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [arm64, x64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache WhisperKit SPM dependencies
        uses: actions/cache@v4
        with:
          path: native/macos/whisperkit-recognizer/.build
          key: whisperkit-spm-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('native/macos/whisperkit-recognizer/Package.resolved') }}
          restore-keys: |
            whisperkit-spm-${{ runner.os }}-${{ runner.arch }}-

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Package for macOS (${{ matrix.arch }})
        run: npx electron-builder --mac --${{ matrix.arch }} --publish never
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.arch }}
          path: |
            release/*.dmg
            release/*-mac.zip
          if-no-files-found: error

  release:
    needs: build-mac
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          generate_release_notes: true
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.zip
          body: |
            ## Workstation ${{ github.ref_name }}

            ### Install

            The desktop app bundles the plugin â€” no separate plugin install needed.

            1. Download the DMG for your platform below
            2. Open the DMG and drag **Workstation** to Applications
            3. Launch the app. All Claude Code sessions started from Workstation automatically have the plugin skills available.

            This build is signed and notarized by Apple. macOS Gatekeeper should allow it without issues. If you still see a warning on first launch:
            - **macOS 14 and earlier:** Right-click the app > Open > click Open
            - **macOS 15 (Sequoia):** System Settings > Privacy & Security > "Open Anyway"

            ### Downloads

            - **macOS (Apple Silicon):** `*-arm64.dmg`
            - **macOS (Intel):** `*-x64.dmg`

            ### Alternative: Install the plugin standalone

            If you prefer to add skills to standalone Claude Code sessions too:
            ```
            /plugin marketplace add https://github.com/varie-ai/workstation
            /plugin install varie-workstation@varie-workstation
            ```
            The Workstation app downloads and launches automatically on your next session.
